version: '3.8'

services:
  # Video Manager Service - Reads video and streams frames to shared memory
  video-manager:
    build:
      context: ../video_manager_service
      dockerfile: Dockerfile
    container_name: video-manager
    environment:
      - VIDEO_SOURCE=/app/videos/video1.mp4
      - VIDEO_WIDTH=640
      - VIDEO_HEIGHT=480
      - VIDEO_SHM_PATH=/dev/shm/video_frame.bgr
      - LOG_FILE_PATH=/app/logs/video_manager.log
    volumes:
      - ../videos:/app/videos:ro
      - ../logs:/app/logs
      - /dev/shm:/dev/shm
    command: python src/main.py
    networks:
      - app-network
    restart: unless-stopped
  
  # Algorithm Service - Reads frames from shared memory and applies detection
  algorithm-service:
    build:
      context: ../algorithm_service
      dockerfile: Dockerfile
    container_name: algorithm-service
    depends_on:
      - video-manager
    environment:
      - LOG_FILE_PATH=/app/logs/algorithm.log
    volumes:
      - ../logs:/app/logs
      - /dev/shm:/dev/shm
    network_mode: host
    restart: unless-stopped

networks:
  app-network:
    driver: bridge